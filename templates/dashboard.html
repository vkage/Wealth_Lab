{% extends "layouts/base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-8">

    <!-- Header / Search -->
    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
            <h2 class="text-3xl font-bold text-white">Market Analysis</h2>
            <p class="text-gray-400">Analyze any stock with Minervini & Dual Momentum strategies.</p>
        </div>

        <div class="relative w-full md:w-96">
            <input type="text" id="tickerInput" placeholder="Enter Ticker (e.g. RELIANCE)"
                class="w-full bg-gray-800 border border-gray-700 text-white rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-500 uppercase">
            <button onclick="analyzeStock()"
                class="absolute right-2 top-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded-lg transition">
                Analyze
            </button>
            <div id="suggestions"
                class="absolute z-50 w-full bg-gray-800 border border-gray-700 rounded-b-xl mt-1 hidden"></div>
        </div>
    </div>

    <!-- Market Overview -->
    {% if metrics %}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Benchmark Card -->
        <a href="/?q=^NSEI" class="block group">
            <div
                class="glass-panel p-6 rounded-2xl flex items-center justify-between relative overflow-hidden group-hover:bg-white/5 transition">
                <!-- Background Glow based on Status -->
                <div
                    class="absolute inset-0 opacity-10 {{ 'bg-green-500' if metrics.benchmark.status == 'Strong Buy' else ('bg-blue-500' if metrics.benchmark.status == 'Accumulation' else ('bg-red-500' if metrics.benchmark.status == 'Weak' else 'bg-yellow-500')) }}">
                </div>

                <div class="relative z-10">
                    <h3
                        class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1 group-hover:text-blue-400 transition">
                        Benchmark Momentum</h3>
                    <div class="flex items-baseline space-x-2">
                        <div class="text-2xl font-bold text-white">{{ metrics.benchmark.name }}</div>
                    </div>

                    <div class="mt-2 flex items-center space-x-2">
                        <!-- Status Badge -->
                        <span
                            class="px-2 py-1 rounded text-xs font-bold 
                            {{ 'bg-green-500 text-white' if metrics.benchmark.status == 'Strong Buy' else 
                               ('bg-blue-500 text-white' if metrics.benchmark.status == 'Accumulation' else 
                                ('bg-red-500 text-white' if metrics.benchmark.status == 'Weak' else 'bg-yellow-500 text-black')) }}">
                            {{ metrics.benchmark.status }}
                        </span>
                        <span class="text-xs text-gray-300 uppercase tracking-wide">: {{ metrics.benchmark.trend
                            }}</span>
                    </div>

                    <div
                        class="text-xs font-mono mt-2 {{ 'text-green-400' if metrics.benchmark.change_1y >= 0 else 'text-red-400' }}">
                        {{ "{:+,.2f}".format(metrics.benchmark.change_1y) }}% (1Y)
                    </div>
                </div>

                <div class="w-48 h-20 relative z-10">
                    <canvas id="benchChart"></canvas>
                </div>
            </div>
        </a>

        <!-- Breadth Card -->
        <div class="glass-panel p-6 rounded-2xl">
            <h3 class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-2">
                {{ metrics.breadth.label }}
            </h3>
            <div class="flex items-center space-x-4 mb-3">
                <div class="text-green-400 font-bold text-xl">{{ metrics.breadth.bullish }} Bull</div>
                <div class="text-yellow-500 font-bold text-xl">{{ metrics.breadth.neutral }} Mixed</div>
                <div class="text-red-400 font-bold text-xl">{{ metrics.breadth.bearish }} Bear</div>
                <div class="text-gray-500 text-sm">/ {{ metrics.breadth.total }} Total Stocks</div>
            </div>

            <!-- Progress Bar -->
            <div class="relative w-full h-3 bg-gray-800 rounded-full overflow-hidden flex">
                {% set total = metrics.breadth.total if metrics.breadth.total > 0 else 1 %}
                <div class="h-full bg-gradient-to-r from-green-600 to-green-400"
                    style="width: {{ (metrics.breadth.bullish / total) * 100 }}%"></div>
                <div class="h-full bg-yellow-600" style="width: {{ (metrics.breadth.neutral / total) * 100 }}%"></div>
                <div class="h-full bg-gradient-to-r from-red-400 to-red-600"
                    style="width: {{ (metrics.breadth.bearish / total) * 100 }}%"></div>
            </div>
            <div class="flex justify-between text-[10px] text-gray-500 mt-1 uppercase">
                <span>Pass (Broad Uptrend)</span>
                <span>Fail (Downtrend)</span>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Portfolio Tiles -->
    {% if portfolios %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        {% for p in portfolios %}
        <a href="{{ url_for('portfolio_view', pid=p.id) }}" class="block group h-full">
            <div
                class="glass-panel p-6 rounded-2xl hover:bg-white/5 transition border-t-4 {{ 'border-green-500' if p.pnl >= 0 else 'border-red-500' }} h-full flex flex-col">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="font-bold text-lg text-white group-hover:text-blue-400 transition">{{ p.name }}</h3>
                    <span class="text-xs text-gray-500 bg-gray-800 px-2 py-1 rounded-lg">{{ p.count }} Stocks</span>
                </div>

                <div class="flex-1 flex flex-col justify-between space-y-4">
                    <!-- Sector Mini Chart -->
                    <div class="h-32 relative">
                        <canvas id="chart-sector-{{ p.id }}"></canvas>
                    </div>

                    <div class="space-y-1 mt-auto">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-400">Value</span>
                            <span class="font-mono text-white">â‚¹{{ "{:,.0f}".format(p.current) }}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-400">P/L</span>
                            <span class="font-mono {{ 'text-green-400' if p.pnl >= 0 else 'text-red-400' }}">
                                {{ "{:+,.0f}".format(p.pnl) }} ({{ "{:+.1f}".format(p.pnl_pct) }}%)
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </a>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Plotly CDN -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Chart Modal for Full Screen -->
    <div id="chartModal" class="fixed inset-0 bg-black/90 z-50 hidden flex flex-col p-4">
        <div class="flex justify-between items-center mb-4 px-4">
            <h2 id="modalChartTitle" class="text-xl font-bold text-white">Full Screen Chart</h2>
            <button onclick="closeChartModal()"
                class="text-gray-400 hover:text-white bg-gray-800 px-4 py-2 rounded-lg">Close</button>
        </div>
        <div id="modalChartContainer" class="flex-1 w-full bg-gray-900 rounded-xl relative"></div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="hidden text-center py-20">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
        <p class="mt-4 text-gray-400">Crunching numbers...</p>
    </div>

    <!-- Results Container -->
    <div id="results" class="hidden space-y-6">

        <!-- Top Card: Price & Summary -->
        <div
            class="glass-panel rounded-2xl p-6 flex justify-between items-start bg-gradient-to-r from-gray-800 to-gray-900">
            <div>
                <h1 id="resTicker" class="text-4xl font-bold text-white tracking-tight">--</h1>
                <div class="text-2xl font-mono text-blue-400 mt-1">â‚¹<span id="resPrice">--</span></div>
            </div>
            <div class="text-right">
                <div id="resSummaryBadge"
                    class="inline-block px-4 py-2 rounded-full text-sm font-bold bg-gray-700 text-gray-300">--</div>
                <div class="mt-2 text-sm text-gray-400">Strategies Passed</div>
            </div>
        </div>

        <!-- Strategy Tabs -->
        <div class="glass-panel rounded-2xl overflow-hidden">
            <!-- Tabs Header -->
            <div class="flex border-b border-gray-700">
                <button onclick="switchTab('minervini')" id="tab-minervini"
                    class="px-6 py-4 text-sm font-medium text-blue-400 border-b-2 border-blue-400 bg-white/5 transition">Minervini
                    Trend</button>
                <button onclick="switchTab('dual')" id="tab-dual"
                    class="px-6 py-4 text-sm font-medium text-gray-400 hover:text-white transition">Dual
                    Momentum</button>
            </div>

            <!-- Tab Content: Minervini -->
            <div id="content-minervini" class="p-6 space-y-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Status Card -->
                    <div class="lg:col-span-1 space-y-4">
                        <div id="minerviniStatusBox" class="p-4 rounded-xl bg-green-900/20 border border-green-500/30">
                            <h3 class="text-sm font-semibold text-gray-400 uppercase">Status</h3>
                            <div id="minScore" class="text-2xl font-bold text-green-400 mt-1">PASS</div>
                        </div>

                        <!-- Checklist -->
                        <div class="glass-panel p-4 rounded-xl">
                            <h3 class="text-sm font-semibold text-gray-400 mb-3">Analysis Log</h3>
                            <ul id="minDetails" class="space-y-2 text-sm text-gray-300 h-64 overflow-y-auto"></ul>
                        </div>
                    </div>

                    <!-- Chart -->
                    <div class="lg:col-span-2 glass-panel rounded-xl p-4 h-[600px] flex flex-col relative group">
                        <div
                            class="absolute top-4 right-4 z-10 flex space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="toggleTheme('minChartFrame')"
                                class="bg-gray-700/80 hover:bg-blue-600 text-white p-2 rounded-lg text-xs font-bold"
                                title="Toggle Theme">ðŸŒ— Theme</button>
                            <button onclick="openChartModal('minChartFrame', 'Minervini Trend')"
                                class="bg-gray-700/80 hover:bg-blue-600 text-white p-2 rounded-lg text-xs font-bold"
                                title="Full Screen">â›¶ Full</button>
                        </div>
                        <h3 class="text-gray-400 text-sm mb-2 px-2">Trend Analysis Chart</h3>
                        <div id="minChartFrame" class="w-full flex-1 rounded-lg bg-gray-900"></div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Dual Momentum -->
            <div id="content-dual" class="p-6 space-y-6 hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Status Card -->
                    <div class="lg:col-span-1 space-y-4">
                        <div id="dualStatusBox" class="p-4 rounded-xl bg-green-900/20 border border-green-500/30">
                            <h3 class="text-sm font-semibold text-gray-400 uppercase">Status</h3>
                            <div id="dualSignal" class="text-2xl font-bold text-green-400 mt-1">BUY</div>
                        </div>

                        <div class="glass-panel p-4 rounded-xl">
                            <h3 class="text-sm font-semibold text-gray-400 mb-3">Performance Metrics</h3>
                            <ul id="dualMetrics" class="space-y-3"></ul>
                            <div class="mt-4 pt-4 border-t border-gray-700">
                                <ul id="dualDetails" class="space-y-2 text-sm text-gray-300 h-64 overflow-y-auto"></ul>
                            </div>
                        </div>
                    </div>

                    <!-- Chart -->
                    <div class="lg:col-span-2 glass-panel rounded-xl p-4 h-[600px] flex flex-col relative group">
                        <div
                            class="absolute top-4 right-4 z-10 flex space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="toggleTheme('dualChartFrame')"
                                class="bg-gray-700/80 hover:bg-blue-600 text-white p-2 rounded-lg text-xs font-bold"
                                title="Toggle Theme">ðŸŒ— Theme</button>
                            <button onclick="openChartModal('dualChartFrame', 'Dual Momentum')"
                                class="bg-gray-700/80 hover:bg-blue-600 text-white p-2 rounded-lg text-xs font-bold"
                                title="Full Screen">â›¶ Full</button>
                        </div>
                        <h3 class="text-gray-400 text-sm mb-2 px-2">Relative Strength vs Nifty 50</h3>
                        <div id="dualChartFrame" class="w-full flex-1 rounded-lg bg-gray-900"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    function analyzeStock(tickerOverride) {
        const ticker = tickerOverride || document.getElementById('tickerInput').value;
        if (!ticker) return;

        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('results').classList.add('hidden');

        fetch(`/analyze_ticker?ticker=${encodeURIComponent(ticker)}`)
            .then(r => r.json())
            .then(data => {
                document.getElementById('loading').classList.add('hidden');

                if (data.error) {
                    alert(data.error);
                    return;
                }

                renderResults(data);
            })
            .catch(e => {
                alert("Analysis failed");
                document.getElementById('loading').classList.add('hidden');
            });
    }

    function renderResults(data) {
        document.getElementById('results').classList.remove('hidden');

        // Header
        document.getElementById('resTicker').innerText = data.ticker;
        document.getElementById('resPrice').innerText = data.price;

        const summary = data.summary;
        const badge = document.getElementById('resSummaryBadge');
        badge.innerText = `${summary.strategies_passed} Strategies Passed`;
        badge.className = summary.bullish
            ? "inline-block px-4 py-2 rounded-full text-sm font-bold bg-green-600 text-white"
            : (summary.bearish
                ? "inline-block px-4 py-2 rounded-full text-sm font-bold bg-red-600 text-white"
                : "inline-block px-4 py-2 rounded-full text-sm font-bold bg-yellow-600 text-white");

        // Minervini
        const min = data.strategies['Minervini Trend Template'];
        document.getElementById('minScore').innerText = min.status;
        document.getElementById('minScore').className = min.status === 'PASS' ? "text-2xl font-bold text-green-400 mt-1" : "text-2xl font-bold text-red-400 mt-1";

        const minList = document.getElementById('minDetails');
        minList.innerHTML = min.details.map(d => `<li class="flex items-start"><span class="mr-2 text-xs">ðŸ”¹</span>${d}</li>`).join('');

        if (min.chart_json) {
            const fig = JSON.parse(min.chart_json);
            // Default Config to be responsive
            const config = { responsive: true, displayModeBar: false };
            Plotly.newPlot('minChartFrame', fig.data, fig.layout, config);
        } else {
            document.getElementById('minChartFrame').innerHTML = "<p class='text-gray-500 text-center pt-20'>No Chart Data</p>";
        }

        // Dual Momentum
        const dual = data.strategies['Dual Momentum (Antonacci)'];
        document.getElementById('dualSignal').innerText = dual.signal;

        if (dual.chart_json) {
            const fig = JSON.parse(dual.chart_json);
            const config = { responsive: true, displayModeBar: false };
            Plotly.newPlot('dualChartFrame', fig.data, fig.layout, config);
        } else {
            document.getElementById('dualChartFrame').innerHTML = "<p class='text-gray-500 text-center pt-20'>No Chart Data</p>";
        }

        const dualMetrics = document.getElementById('dualMetrics');
        const m = dual.metrics || {};
        dualMetrics.innerHTML = `
            <li class="flex justify-between text-sm"><span class="text-gray-400">Stock 1yr</span> <span class="${parseFloat(m.Stock_1yr_Ret) > 0 ? 'text-green-400' : 'text-red-400'}">${m.Stock_1yr_Ret}</span></li>
            <li class="flex justify-between text-sm"><span class="text-gray-400">Benchmark 1yr</span> <span>${m.Bench_1yr_Ret}</span></li>
            <li class="flex justify-between text-sm"><span class="text-gray-400">Alpha</span> <span class="font-bold text-white">${m.Alpha}</span></li>
        `;
        document.getElementById('dualDetails').innerHTML = dual.details.map(d => `<li class="flex items-start"><span class="mr-2 text-xs">ðŸ”¹</span>${d}</li>`).join('');
    }

    function switchTab(tab) {
        ['minervini', 'dual'].forEach(t => {
            const btn = document.getElementById(`tab-${t}`);
            const content = document.getElementById(`content-${t}`);

            if (t === tab) {
                btn.classList.add('text-blue-400', 'border-b-2', 'border-blue-400', 'bg-white/5');
                btn.classList.remove('text-gray-400');
                content.classList.remove('hidden');
                // Force Plotly resize on tab switch
                if (t === 'minervini') Plotly.Plots.resize('minChartFrame');
                if (t === 'dual') Plotly.Plots.resize('dualChartFrame');
            } else {
                btn.classList.remove('text-blue-400', 'border-b-2', 'border-blue-400', 'bg-white/5');
                btn.classList.add('text-gray-400');
                content.classList.add('hidden');
            }
        });
    }

    // --- Chart Controls ---

    async function toggleTheme(divId) {
        const div = document.getElementById(divId);
        // Check current template or background color
        // Plotly uses layout.template. We can just check background color
        // If dark -> light, else light -> dark

        // Simpler: Just toggle between plotly_dark and plotly_white
        // We need to access the current layout.
        // There isn't a simple "getTemplate" API, but we can infer from our default

        // Let's assume we toggle.
        // Access existing layout
        const currentLayout = div.layout;
        const isDark = currentLayout.template ? (currentLayout.template.layout.plot_bgcolor !== 'white') : true; // Heuristic

        // Actually, just maintain state or toggle based on paper_bgcolor
        // Default is dark (transparent paper).

        const newTemplate = (div.getAttribute('data-theme') === 'light') ? 'plotly_dark' : 'plotly_white';
        const newBg = (newTemplate === 'plotly_dark') ? 'rgba(0,0,0,0)' : '#ffffff';
        const newFont = (newTemplate === 'plotly_dark') ? '#ffffff' : '#000000';

        const update = {
            'template': null, // Clear template? Hard to swap template entirely dynamically without full re-plot
            'paper_bgcolor': newBg,
            'plot_bgcolor': newBg,
            'font.color': newFont
            // Grid lines etc need manual update if swapping template is hard
        };

        // To really swap template, we might need to re-newPlot with new template layout
        // But let's try relayout first.
        Plotly.relayout(divId, update);
        div.setAttribute('data-theme', (newTemplate === 'plotly_dark') ? 'dark' : 'light');
    }

    let currentModalChart = null;

    function openChartModal(sourceDivId, title) {
        const modal = document.getElementById('chartModal');
        const container = document.getElementById('modalChartContainer');
        const titleEl = document.getElementById('modalChartTitle');
        const sourceDiv = document.getElementById(sourceDivId);

        titleEl.innerText = title;
        modal.classList.remove('hidden');

        // Copy data from source
        const data = sourceDiv.data;
        const layout = JSON.parse(JSON.stringify(sourceDiv.layout)); // Deep copy

        // Adjust layout for modal
        layout.height = undefined; // Auto height
        layout.width = undefined; // Auto width
        layout.autosize = true;

        Plotly.newPlot('modalChartContainer', data, layout, { responsive: true });
        currentModalChart = 'modalChartContainer';
    }

    function closeChartModal() {
        document.getElementById('chartModal').classList.add('hidden');
        Plotly.purge('modalChartContainer');
        currentModalChart = null;
    }

    // Resize modal chart on window resize
    window.addEventListener('resize', () => {
        if (currentModalChart) Plotly.Plots.resize(currentModalChart);
    });

    // Auto-search logic (Same as old but cleaner)
    const input = document.getElementById('tickerInput');
    const suggestBox = document.getElementById('suggestions');

    input.addEventListener('input', async (e) => {
        const q = e.target.value;
        if (q.length < 2) { suggestBox.classList.add('hidden'); return; }

        const res = await fetch(`/suggest?q=${encodeURIComponent(q)}`);
        const list = await res.json();

        if (list.length > 0) {
            suggestBox.innerHTML = list.map(t =>
                `<div class="px-4 py-2 hover:bg-gray-700 cursor-pointer" onclick="selectTicker('${t}')">${t}</div>`
            ).join('');
            suggestBox.classList.remove('hidden');
        }
    });

    function selectTicker(t) {
        input.value = t;
        suggestBox.classList.add('hidden');
        analyzeStock();
    }

    // Auto-load from URL param
    document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        const ticker = params.get('q');
        if (ticker) {
            document.getElementById('tickerInput').value = ticker;
            analyzeStock(ticker);
        }
    });
</script>
{% endblock %}